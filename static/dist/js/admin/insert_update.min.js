define(["jquery-nos","jquery-ui.sortable","jquery-ui.resizable"],function(a){"use strict";return function(b,c,d,e){function f(){var b="";return Y.find("tr.preview_row").each(function(c){var d=a(this).find("td.preview");d.length>0&&""!=b&&(b+="\n"),d.each(function(c){var d=a(this),e=s(d);if(e){c>0&&(b+=",");var f=d.is(".page_break")?"page_break":o(e);b+=f+"="+M(d)}})}),b}function g(){return Y.find("tr.preview_row.page_break").length}function h(b){var c=(fa.data("params")||{}).where||"bottom",d=Y.closest(".nos-fixed-content").get(0),e=d.scrollTop;a.ajax({url:"admin/noviusos_form/form/render_layout/"+b,dataType:"json",success:function(b){if(fa.hide(),b.fields&&b.layout){var f=a(b.fields.join(""));"top"==c&&(f=a(f.get().reverse())),$.append(f),f=f.not("script"),f.nosFormUI();var g=a();f.each(function(d){var e=a(this);l(e,c),b.previews&&b.previews[d]?A(e,b.previews[d]):G(e),E(e),g=g.add(q(e))}),S(b.layout),d.scrollTop=e,g.addClass("ui-state-hover"),setTimeout(function(){g.removeClass("ui-state-hover")},500)}}})}function i(a){if(a=a||Z.find(".preview.ui-state-active"),0==a.length&&(a=aa.not(":not(.ui-state-active)")),a.length>0){var b=a.is(".submit_informations")?14:-40,c=a.position();$.css({paddingTop:Math.max(0,c.top+b)+"px"})}}function j(a){var b=$.find(".show_hide").show();a&&a.is(".page_break")?b.addClass("page_break"):b.removeClass("page_break")}function k(){$.find(".show_hide").hide().removeClass("page_break")}function l(a,b){var c=u(a,"field_driver");if(0!=c.length&&c.val()){var d=o(a);d&&p(d,b),a.hide()}}function m(a){n(a)}function n(b){b.find("[data-wysiwyg-options]").each(function(){var b=a(this),c=new V(500);T(b).done(function(){b.on("change",function(){c.request(function(a){G(b.closest(".field_enclosure")),a()})})})})}function o(a){return a.data("field-id")||u(a,"field_id").val()}function p(a,b){var c=ea.clone(),d=c.find("td.preview");switch(L(d,4),d.data("field-id",a),d.attr("data-field-id",a),d.find("button.notransform").removeClass("notransform"),d.nosFormUI().show().nosOnShow(),b){case"top":Z.prepend(d.parent());break;case"bottom":default:Z.append(d.parent())}return d}function q(a){return r(o(a))}function r(a){var b=Z.find('.preview[data-field-id="'+a+'"]');return!!b.length&&b}function s(a){var b=a.data("field-id"),c=$.find('.field_enclosure[data-field-id="'+b+'"]');return!!c.length&&c}function t(a){for(var b=a.find(":input").serializeArray(),c=0;c<b.length;c++)b[c].name=b[c].name.replace(/field\[[0-9]*\]\[([^\]]+)\]/,"$1");return b}function u(a,b){return a.find('[name$="['+b+']"]')}function v(a){j(a),a.is(".field_enclosure")&&(a.show(),a.nosOnShow()),a.siblings(".field_enclosure").hide(),i(),0==u(a,"field_submit_label").length&&aa.removeClass("ui-state-active")}function w(a){k(),a&&a.hide()}function x(a){var b=q(a);a.remove(),k(),b&&b.addClass("ui-state-error").hide(500,function(){b.remove(),R()})}function y(a){a.addClass("frozen"),q(a).addClass("frozen")}function z(a){a.removeClass("frozen"),q(a).removeClass("frozen")}function A(b,c){var d=q(b),e=u(b,"field_details").val();e&&e.length>0&&(c+='<div class="details">'+a("<div/>").text(e).html()+"</div>"),d.find("div.preview_content").html(c),d.find("input, select").attr("readonly",!0).on("click",function(a){var c=B();c&&c.data("field-id")!==b.data("field-id")||(a.preventDefault(),a.stopPropagation())}),H(d.closest("tr"))}function B(){return s(Z.find(".preview.ui-state-active"))}function C(){var a=Z.find(".ui-widget-content.ui-state-active");a.length>0&&(a.removeClass("ui-state-active"),w(s(a)))}function D(a){var b=q(a);b&&(Z.find("td.preview.ui-state-active").removeClass("ui-state-active"),b.addClass("ui-state-active"))}function E(a){var b=q(a);if(b){var c=b.find("label.preview_label");J("field_label",u(a,"field_driver").val())?(c.text(F(a)),c.show()):c.hide()}}function F(a){var b=u(a,"field_label").val();return u(a,"field_mandatory").is(":checked")&&(b+="*"),b}function G(b){var c=o(b),d=t(b);ca.request(function(e){a.ajax({url:"admin/noviusos_form/form/render_field_preview/"+c,type:"POST",dataType:"json",data:{fieldData:JSON.stringify(d)}}).done(function(a){void 0!==a.preview&&A(b,a.preview)}).always(function(){e()})})}function H(b){(b||Z.find("tr")).css("height","").each(function(){a(this).find("div.resizable").css("height","").css("height",a(this).height())})}function I(a,b,d){var e=c.driversConfig[a]||{};return b?U(e.config,b,d):e.config}function J(b,c){var d=I(c);if(d){var e=U(d,"admin.layout");if("object"==typeof e)for(var f in e)if(e.hasOwnProperty(f)&&"object"==typeof e[f].fields&&-1!==a.inArray(b,e[f].fields))return!0}return!1}function K(b,c){if(0!=b.find("td:not(.padding)").length){b.find("td.padding").remove();var d=b.find("td.preview:visible"),e=[],f=0,g=[],h=5-d.length;if(d.each(function(){var b=a(this),c=b.find(".resizable");0==c.length&&(c=b);var d=Math.round(c.outerWidth()/ga);d=Math.max(1,Math.min(h,d)),d=parseInt(c.attr("colspan"))||d,e.push(d),f+=d,b.data("colspan",d),(0==g.length||d>g.data("colspan"))&&(g=b)}),f>4){void 0!==c&&null!=c||(c=g.get(0));var i=f-4;d.filter(function(){return a(this).data("colspan")>1&&this!=c}).closest("td.preview").each(function(){for(var b=a(this),c=b.data("colspan"),d=1;c-d>1&&i-d>0;)d++;i-=d,b.data("colspan",c-d)}),i>0&&a(c).data("colspan",a(c).data("colspan")-i)}if(b.find("td.preview").each(function(){L(a(this),a(this).data("colspan")),a(this).removeData("colspan")}),f<4){var j=a('<td class="padding">&nbsp;</td>');L(j,4-f),b.append(j)}}}function L(a,b){a.attr("colspan",b).children().css("width","auto")}function M(a){return Math.round(a.width()/ga)}function N(b){b.find("td.preview:visible").each(function(){var b=a(this);b.data("saved_colspan",M(b))})}function O(b){b.find("td.preview:visible").each(function(){var b=a(this),c=b.data("saved_colspan");c&&L(b,c)})}function P(){try{X.destroy()}catch(a){}Z.find("td.padding").remove(),Z.find("td.sortable_placeholder").remove(),Z.find("tr").addClass("preview_row").filter(function(){return 0==a(this).children().not(".placeholder").length}).remove(),Z.find("td.page_break").each(function(){var b=a(this);L(b,4),b.closest("tr").addClass("page_break")}),Z.find("tr").before('<tr class="preview_row preview_inserter"><td class="padding" colspan="4">&nbsp;</td></tr>'),Z.append('<tr class="preview_row preview_inserter"><td class="padding" colspan="4">&nbsp;</td></tr>'),Z.find("tr.preview_row").each(function(){K(a(this))}),Z.find("tr").removeClass("preview_row_sortable").filter(function(){return a(this).children().not(".padding").length<4}).addClass("preview_row_sortable");var c;X=Z.find("tr.preview_row:not(.page_break)").sortable({connectWith:b+" tr.preview_row_sortable:not(.page_break)",dropOnEmpty:!0,helper:"clone",appendTo:b,items:"> td.preview",forceHelperSize:!0,placeholder:"sortable_placeholder preview",tolerance:"pointer",handle:".handle",beforeStop:function(a,b){},start:function(a,b){var c=b.placeholder.closest("tr");C(),c.css("height",b.item.height()),b.placeholder.addClass("ui-widget-content ui-state-active"),b.placeholder.children().css("height",c.css("height")),L(b.placeholder,M(b.helper))},update:function(a,b){var d=b.item.closest("tr");d.css("height",""),d.children().css("height",d.css("height")),L(b.item,c),K(d,b.item.get(0)),R()},over:function(a,b){var d=b.placeholder.closest("tr");b.item.children().css("height",""),b.placeholder.hide(),N(d),b.placeholder.show(),b.placeholder.children().css("height",d.css("height")),L(b.placeholder,M(b.helper)),K(d,b.placeholder.get(0)),c=M(b.placeholder)},out:function(a,b){O(b.placeholder.closest("tr"))}}),Z.find("tr.preview_row.page_break").sortable({appendTo:b,connectWith:b+" tr.preview_row_sortable.preview_inserter",helper:"clone",dropOnEmpty:!0,forceHelperSize:!0,forcePlaceholderSize:!0,placeholder:"sortable_placeholder preview",handle:".handle",start:function(a,b){var c=b.placeholder.closest("tr");C(),c.css("height",b.item.height()),b.placeholder.addClass("ui-widget-content ui-state-active"),b.placeholder.children().css("height",c.css("height")),L(b.placeholder,4)}})}function Q(){try{W.destroy()}catch(a){}W=Z.find("td.preview").not(".page_break").find("div.resizable"),W=W.resizable({ghost:!0,handles:"se",autoHideType:!0,helper:"helper_resize preview ui-state-active",grid:[ga,"2000"],start:function(a,b){C()},stop:function(a,b){var c=b.element.closest("tr");K(c,b.element.closest("td").get(0)),H(c)}})}function R(a){Q(),P(),H(a)}function S(b){a.each(b.split("\n"),function(){var b=null;""!=this&&a.each(this.split(","),function(){var a=this.split("="),c=a[0],d=a[1],e=r(c);e&&(L(e,d),b&&b.after(e),b=e)})}),R()}function T(a){var b=jQuery.Deferred();return a.nosOnShow("one",function(){setTimeout(function(){require(["jquery-nos-wysiwyg"],function(c){c(function(){setTimeout(function(){if("undefined"==typeof tinyMCE)return console.warn("Cannot find TinyMCE."),void b.reject();var c=tinyMCE.get(a.prop("id"));if(void 0===c)return console.warn("Cannot find the TinyMCE editor instance."),void b.reject();c.onChange.add(function(){a.trigger("change")}),c.onKeyUp.add(function(){a.trigger("change")}),b.resolve()},100)})})},1)}),b.promise()}function U(a,b,c){var d=b.split(".").reduce(function(a,b){return a?a[b]:void 0},a||self);return void 0!==d?d:c}function V(a){var b,c,d;"number"!=typeof a&&(a=1e3);var e=function(e){b=!0;var f=function(){b=!1,d=+new Date,c&&(c(),c=null)};if(d){var g=+new Date-d;if(g<a)return void setTimeout(function(){e(f)},a-g)}e(f)};this.request=function(a){b?c=function(){e(a)}:e(a)}}var W,X,Y=a(b),Z=Y.find(".preview_container"),$=Y.find(".fields_container"),_=Y.closest("form").find("[name=form_layout]"),aa=Y.find(".submit_informations"),ba=a('.nos-ostabs-panel.ui-widget-content:not(".nos-ostabs-hide")'),ca=new V(800),da=new V(500);$.show(),aa.show();var ea=Y.find("[data-id=clone_preview]").clone().removeAttr("data-id");Y.find("[data-id=clone_preview]").remove();var fa=Y.find(".field_blank_slate");fa.find("label").hover(function(){a(this).addClass("ui-state-hover")},function(){a(this).removeClass("ui-state-hover")});var ga=Math.round(Z.outerWidth()/4);Z.width(Z.outerWidth()-Z.width()),a(document).ready(function(){ba.find('button.ui-priority-primary[type="submit"]').unbind().bind("click",function(){Y.closest("form").submit()})}),Y.closest("form").submit(function(b){var c=a(this).get(0);if("function"==typeof c.checkValidity&&!c.checkValidity())return!1;var d=f();_.val(d);var e={form_layout:d},g={},h=/[^\[]+\[([0-9]+)\]\[([^\]]+)\]/;a(this).find(":input").each(function(){var b=a(this);if(b.attr("name")){if(0!=b.attr("name").indexOf("field["))return void((b.not('[type="checkbox"]').length||b.is(":checked"))&&(e[b.attr("name")]=b.val()));var c=b.attr("name").match(h);if(c.length&&!(c.length<3)){var d=parseInt(c[1]),f=c[2],i=b.val();b.is(":checkbox")&&(i=+b.is(":checked")),d&&f&&(g[d]||(g[d]={}),g[d][f]=i)}}}),e._csrf=a(this).find('input[name="_csrf"]:first').val(),e.fields=JSON.stringify(g);var i=a(this).attr("action");return Y.nosAjax({data:e,type:"post",url:i,dataType:"json"}),!1}),Y.on("click","[data-id=add]",function(b){b.preventDefault(),b.stopPropagation();var c=a(this).data("params");fa.data("params",c);var d=g();if("page_break"==c.type){var e="page-break-"+(d+1),f=a("<div />").addClass("field_enclosure page_break").attr("data-field-id",e).data("field-id",e);$.append(f),f.nosFormUI();p(e,c.where||"bottom").addClass("page_break ui-widget-header"),S("page_break=4")}else a(this).closest(".button-container")["top"===c.where?"append":"prepend"](fa),fa.show(),i()}),a("html, body").on("click",function(){fa.hide()}),fa.on("click",function(a){a.stopPropagation()}),fa.on("click","label",function(b){b.preventDefault(),h(a(this).data("layout-name"))}),Z.on("click","td.preview",function(b){b.preventDefault();var c=a(this),d=s(c);d&&(D(d),v(d),n(d),u(d,"field_label").focus())}),Z.on("click","[data-id=copy]",function(a){a.preventDefault(),a.stopPropagation()}),$.on("click","[data-id=delete]",function(b){if(b.preventDefault(),b.stopPropagation(),confirm(a.nosCleanupTranslation(c.textDelete))){var d=B();d&&x(d)}}),$.on("change",'select[name$="[field_driver]"]',function(b){var c=a(this).closest(".field_enclosure"),d=o(c),e=t(c);y(c),a.ajax({url:"admin/noviusos_form/form/render_field/"+d,type:"POST",dataType:"json",data:{fieldData:JSON.stringify(e)}}).done(function(b){if(b.meta){var d=a(b.meta);c.replaceWith(d),c=d,c.nosFormUI()}E(c),void 0!==b.preview?A(c,b.preview):G(c),c.find(".wijmo-wijaccordion-content").each(function(){var b=a(this);0==b.find(":input").filter(function(){return"none"!=a(this).closest("p").css("display")}).length?b.prev().hide():b.prev().show()}),c.find('[name$="[field_label]"]').trigger("change"),c.find('[name$="[field_style]"]').trigger("change"),m(c)}).always(function(){z(c)})}),$.on("change",'select[name$="[field_style]"]',function(b){var c=a(this).val(),d=a(this).closest(".field_enclosure"),e=d.find('[name$="[field_message]"]'),f=a("p"==c?'<textarea rows="4"></textarea>':'<input type="text" />');f.attr({name:e.attr("name"),id:e.attr("id")}),f.val(e.val()),f.insertAfter(e),e.remove(),f.parent().nosFormUI(),f.trigger("change")}),$.on("change keyup",'input[name$="[field_label]"]',function(){E(a(this).closest(".field_enclosure"))}),$.on("change",'input[name$="[field_mandatory]"]',function(){E(a(this).closest(".field_enclosure"))}),$.on("change keyup",'textarea[name$="[field_choices]"],[name$="[field_message]"],[name$="[field_default_value]"],input[name$="[field_width]"],input[name$="[field_height]"],textarea[name$="[field_details]"]',function(){G(a(this).closest(".field_enclosure"))}),$.on("refreshPreview",".field_enclosure",function(){var b=a(this);G(b),E(b)}),$.children(".field_enclosure").hide(),k(),S(_.val()),setTimeout(function(){H()},100),$.children(".field_enclosure").each(function(){E(a(this))}),d&&h("default");var ha=Y.find("[name=form_captcha]"),ia=Y.find("[name=form_submit_label]"),ja=Y.find("[name=form_submit_email]"),ka=Y.find('[name="wysiwygs->submit_consent->wysiwyg_text"]'),la=aa.find(".form_submit_consent");ha.on("change",function(){aa.find(".form_captcha")[a(this).is(":checked")?"show":"hide"]()}).trigger("change"),ia.on("change keyup",function(){aa.find("input:last").val(a(this).val())}).trigger("change"),ja.on("change keyup",function(){var b=a.trim(a(this).val());aa.find(".form_submit_email").find("span:first").html(b.replace("\n",", ","g")).end().find("span:last")[b?"hide":"show"]()}).trigger("change"),aa.find(".form_submit_consent").on("refresh",function(){a(this).html(ka.val())}).trigger("refresh"),T(ka).done(function(){ka.on("change",function(){da.request(function(a){la.trigger("refresh"),a()})})}),aa.on("click",function(){var a=ia.closest(".accordion");C(),v(a),w(),i(aa),aa.addClass("ui-state-active"),Y.find(".preview_arrow").show()})}});
//# sourceMappingURL=insert_update.min.js.map